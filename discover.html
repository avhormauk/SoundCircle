<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Your Music Community - SoundCircle</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="discover-page">
    <div class="container">
        <header class="page-header">
            <h1>üéµ Your Music Community</h1>
            <a href="index.html" class="back-link">‚Üê Add yourself</a>
        </header>

        <div class="view-toggle">
            <button id="gridView" class="view-btn active">Grid View</button>
            <button id="mapView" class="view-btn">Map View</button>
        </div>

        <div class="filters">
            <button id="useMyLocation" class="location-filter-btn">
                üìç Near Me
            </button>
            <input type="text" id="searchLocation" placeholder="üîç Filter by location..." class="filter-input">
            <input type="text" id="searchArtist" placeholder="üîç Filter by artist..." class="filter-input">
            <button id="clearFilters" class="clear-btn">Clear</button>
        </div>

        <div class="stats-bar">
            <p id="resultCount">Loading community...</p>
            <p id="currentlyListening">üéß <span id="listeningCount">0</span> people listening now</p>
        </div>

        <!-- Grid View -->
        <div id="userGrid" class="user-grid active-view">
            <div class="loading">
                <p>üéµ Loading your music community...</p>
            </div>
        </div>

        <!-- Map View -->
        <div id="mapViewContainer" class="map-view hidden">
            <div id="map" class="map-container">
                <div class="map-placeholder">
                    <p>üìç Map view coming soon!</p>
                    <p>This will show users at their universities with clickable nodes.</p>
                </div>
            </div>
            <div id="mapSidebar" class="map-sidebar">
                <h3>University Hotspots</h3>
                <div id="universityList" class="university-list">
                    <!-- Universities will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ===== CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyAbDk7yBcmoq1f7YispIZty1J7M9sg8ycU",
            authDomain: "soundcircle-7ebd7.firebaseapp.com",
            projectId: "soundcircle-7ebd7",
            storageBucket: "soundcircle-7ebd7.firebasestorage.app",
            messagingSenderId: "313939828422",
            appId: "1:313939828422:web:3c45183871d17910b641c7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allUsers = [];
        let filteredUsers = [];
        let currentLocation = null;

        // ===== LOAD USERS (REAL-TIME) =====
        db.collection('users')
            .orderBy('lastUpdated', 'desc')
            .onSnapshot((snapshot) => {
                allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                filteredUsers = [...allUsers];
                displayUsers(filteredUsers);
                updateStats(filteredUsers.length, allUsers.length);
                updateCurrentlyListeningCount();
                updateUniversityList();
            }, (error) => {
                console.error('Error loading users:', error);
                document.getElementById('userGrid').innerHTML = `
                    <div class="error">
                        <p>‚ùå Error loading community data.</p>
                        <p>Make sure Firebase is properly configured.</p>
                    </div>
                `;
            });

        // ===== DISPLAY USERS =====
        function displayUsers(users) {
            const grid = document.getElementById('userGrid');
            
            if (users.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h2>üéµ No matches found</h2>
                        <p>Try adjusting your filters or be the first to join!</p>
                        <a href="index.html" class="cta-button">Join the Community</a>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = users.map(user => {
                const artistsHTML = user.artists && user.artists.length > 0
                    ? user.artists.slice(0, 3).map(a => `<span class="tag">${a}</span>`).join('')
                    : '<span class="tag">Music Lover</span>';
                
                const contactHTML = user.contact 
                    ? `<p class="contact">üí¨ ${user.contact}</p>` 
                    : '<p class="contact-note">No contact shared</p>';

                const currentlyPlayingHTML = user.currentlyPlaying 
                    ? `<div class="currently-playing">
                         <p class="now-playing">üéß Now Playing: <a href="${user.currentlyPlaying.url}" target="_blank">${user.currentlyPlaying.name} - ${user.currentlyPlaying.artist}</a></p>
                       </div>`
                    : '';

                return `
                    <div class="user-card" data-location="${user.location}" data-artists="${(user.artists || []).join(',')}">
                        <div class="card-header">
                            <h3>${user.name || 'Anonymous User'}</h3>
                        </div>
                        
                        <p class="location">üìç ${user.location || 'Unknown Location'}</p>
                        
                        ${currentlyPlayingHTML}
                        
                        <div class="artists-section">
                            <strong>Top Artists:</strong>
                            <div class="artist-tags">
                                ${artistsHTML}
                            </div>
                        </div>
                        
                        <div class="actions">
                            ${user.spotifyUrl ? `<a href="${user.spotifyUrl}" target="_blank" rel="noopener" class="spotify-link">üéß Spotify Profile</a>` : ''}
                            ${contactHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== UPDATE STATS =====
        function updateStats(shown, total) {
            const resultCount = document.getElementById('resultCount');
            if (shown === total) {
                resultCount.textContent = `Showing all ${total} ${total === 1 ? 'member' : 'members'}`;
            } else {
                resultCount.textContent = `Showing ${shown} of ${total} members`;
            }
        }

        function updateCurrentlyListeningCount() {
            const listeningCount = allUsers.filter(user => user.currentlyPlaying).length;
            document.getElementById('listeningCount').textContent = listeningCount;
        }

        // ===== LOCATION SERVICES =====
        document.getElementById('useMyLocation').addEventListener('click', async function() {
            const button = this;
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = 'Getting location...';
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by this browser.');
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });

                const { latitude, longitude } = position.coords;
                currentLocation = { latitude, longitude };
                
                try {
                    const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
                    const data = await response.json();
                    const locationName = data.city || data.locality || 'Your Location';
                    
                    document.getElementById('searchLocation').value = locationName;
                    button.textContent = 'üìç Near You';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                } catch (error) {
                    document.getElementById('searchLocation').value = 'Near Me';
                    button.textContent = 'üìç Location Found';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                }
                
                filterUsers();
                
            } catch (error) {
                console.error('Error getting location:', error);
                button.textContent = '‚ùå Location failed';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
                alert('Could not get your location. Please enable location services.');
            }
        });

        // ===== FILTER FUNCTIONALITY =====
        function filterUsers() {
            const locationQuery = document.getElementById('searchLocation').value.toLowerCase().trim();
            const artistQuery = document.getElementById('searchArtist').value.toLowerCase().trim();
            
            filteredUsers = allUsers.filter(user => {
                const matchesLocation = !locationQuery || 
                    (user.location && user.location.toLowerCase().includes(locationQuery));
                
                const matchesArtist = !artistQuery || 
                    (user.artists && user.artists.some(a => a.toLowerCase().includes(artistQuery)));
                
                return matchesLocation && matchesArtist;
            });
            
            displayUsers(filteredUsers);
            updateStats(filteredUsers.length, allUsers.length);
        }

        // ===== VIEW TOGGLE =====
        document.getElementById('gridView').addEventListener('click', function() {
            document.getElementById('userGrid').classList.add('active-view');
            document.getElementById('mapViewContainer').classList.add('hidden');
            this.classList.add('active');
            document.getElementById('mapView').classList.remove('active');
        });

        document.getElementById('mapView').addEventListener('click', function() {
            document.getElementById('userGrid').classList.remove('active-view');
            document.getElementById('mapViewContainer').classList.remove('hidden');
            this.classList.add('active');
            document.getElementById('gridView').classList.remove('active');
        });

        // ===== UNIVERSITY LIST FOR MAP VIEW =====
        function updateUniversityList() {
            const universityList = document.getElementById('universityList');
            const universities = {};
            
            allUsers.forEach(user => {
                if (user.location) {
                    universities[user.location] = (universities[user.location] || 0) + 1;
                }
            });
            
            const sortedUniversities = Object.entries(universities)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sortedUniversities.length === 0) {
                universityList.innerHTML = '<p class="no-data">No university data yet</p>';
                return;
            }
            
            universityList.innerHTML = sortedUniversities.map(([university, count]) => `
                <div class="university-item">
                    <span class="university-name">${university}</span>
                    <span class="user-count">${count} ${count === 1 ? 'user' : 'users'}</span>
                </div>
            `).join('');
        }

        // Add event listeners for filters
        document.getElementById('searchLocation').addEventListener('input', filterUsers);
        document.getElementById('searchArtist').addEventListener('input', filterUsers);

        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('searchLocation').value = '';
            document.getElementById('searchArtist').value = '';
            currentLocation = null;
            filterUsers();
        });
    </script>
</body>
</html>