<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Your Music Community - SoundCircle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-top: 15px;
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #93c5fd;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 25px;
            background: #1f1f1f;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .stats-bar p {
            margin: 0;
            color: #a0a0a0;
            font-size: 1rem;
            font-weight: 500;
        }

        #currentlyListening {
            color: #60a5fa;
            font-weight: 600;
        }

        .loading, .empty-state, .error {
            text-align: center;
            padding: 60px 20px;
            background: #1f1f1f;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .loading p {
            color: #a0a0a0;
            font-size: 1.2rem;
        }

        .universities-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .university-section {
            background: #1f1f1f;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            padding: 25px;
            transition: transform 0.3s ease;
        }

        .university-section:hover {
            transform: translateY(-2px);
        }

        .university-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a2a;
        }

        .university-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: #60a5fa;
        }

        .university-count {
            background: #2a2a2a;
            color: #60a5fa;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .user-card {
            background: #161616;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }

        .card-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 12px;
        }

        .location {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .currently-playing {
            margin: 15px 0;
            padding: 12px;
            background: #1a2332;
            border-radius: 8px;
            border-left: 3px solid #60a5fa;
        }

        .now-playing {
            margin: 0;
            font-size: 0.85rem;
            color: #a0a0a0;
            font-weight: 500;
        }

        .now-playing a {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
        }

        .now-playing a:hover {
            text-decoration: underline;
        }

        .artists-section {
            margin: 15px 0;
        }

        .artists-section strong {
            display: block;
            color: #a0a0a0;
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .artist-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            background: #2a2a2a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .actions {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .spotify-link {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .spotify-link:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
        }

        .contact {
            color: #a0a0a0;
            font-size: 0.85rem;
            padding: 8px 0;
        }

        .contact-note {
            color: #666;
            font-size: 0.85rem;
            font-style: italic;
        }

        .empty-state h2 {
            color: #60a5fa;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .empty-state p {
            color: #a0a0a0;
            margin-bottom: 25px;
        }

        .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cta-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .university-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .users-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="discover-page">
    <div class="container">
        <header class="page-header">
            <h1>Your Music Community</h1>
            <a href="index.html" class="back-link">‚Üê Add yourself</a>
        </header>

        <div class="stats-bar">
            <p id="resultCount">Loading community...</p>
            <p id="currentlyListening"><span id="listeningCount">0</span> people listening now</p>
        </div>

        <div id="universitiesContainer" class="universities-container">
            <div class="loading">
                <p>Loading your music community...</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbDk7yBcmoq1f7YispIZty1J7M9sg8ycU",
            authDomain: "soundcircle-7ebd7.firebaseapp.com",
            projectId: "soundcircle-7ebd7",
            storageBucket: "soundcircle-7ebd7.firebasestorage.app",
            messagingSenderId: "313939828422",
            appId: "1:313939828422:web:3c45183871d17910b641c7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allUsers = [];

        db.collection('users')
            .orderBy('lastUpdated', 'desc')
            .onSnapshot((snapshot) => {
                allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayUsersByUniversity(allUsers);
                updateStats(allUsers.length);
                updateCurrentlyListeningCount();
            }, (error) => {
                console.error('Error loading users:', error);
                document.getElementById('universitiesContainer').innerHTML = `
                    <div class="error">
                        <p>Error loading community data.</p>
                        <p>Make sure Firebase is properly configured.</p>
                    </div>
                `;
            });

        function displayUsersByUniversity(users) {
            const container = document.getElementById('universitiesContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No members yet</h2>
                        <p>Be the first to join the community!</p>
                        <a href="index.html" class="cta-button">Join the Community</a>
                    </div>
                `;
                return;
            }

            const usersByUniversity = {};
            users.forEach(user => {
                const uni = user.location || 'Unknown Location';
                if (!usersByUniversity[uni]) {
                    usersByUniversity[uni] = [];
                }
                usersByUniversity[uni].push(user);
            });

            const sortedUniversities = Object.entries(usersByUniversity)
                .sort((a, b) => b[1].length - a[1].length);

            container.innerHTML = sortedUniversities.map(([university, universityUsers]) => `
                <div class="university-section">
                    <div class="university-header">
                        <h2 class="university-name">${university}</h2>
                        <span class="university-count">${universityUsers.length} ${universityUsers.length === 1 ? 'member' : 'members'}</span>
                    </div>
                    <div class="users-grid">
                        ${universityUsers.map(user => {
                            const artistsHTML = user.artists && user.artists.length > 0
                                ? user.artists.slice(0, 3).map(a => `<span class="tag">${a}</span>`).join('')
                                : '<span class="tag">Music Lover</span>';
                            
                            const contactHTML = user.contact 
                                ? `<p class="contact">${user.contact}</p>` 
                                : '<p class="contact-note">No contact shared</p>';

                            const currentlyPlayingHTML = user.currentlyPlaying 
                                ? `<div class="currently-playing">
                                     <p class="now-playing">Now Playing: <a href="${user.currentlyPlaying.url}" target="_blank">${user.currentlyPlaying.name} - ${user.currentlyPlaying.artist}</a></p>
                                   </div>`
                                : '';

                            return `
                                <div class="user-card">
                                    <div class="card-header">
                                        <h3>${user.name || 'Anonymous User'}</h3>
                                    </div>
                                    
                                    ${currentlyPlayingHTML}
                                    
                                    <div class="artists-section">
                                        <strong>Top Artists:</strong>
                                        <div class="artist-tags">
                                            ${artistsHTML}
                                        </div>
                                    </div>
                                    
                                    <div class="actions">
                                        ${user.spotifyUrl ? `<a href="${user.spotifyUrl}" target="_blank" rel="noopener" class="spotify-link">Spotify Profile</a>` : ''}
                                        ${contactHTML}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function updateStats(total) {
            const resultCount = document.getElementById('resultCount');
            resultCount.textContent = `${total} ${total === 1 ? 'member' : 'members'} in the community`;
        }

        function updateCurrentlyListeningCount() {
            const listeningCount = allUsers.filter(user => user.currentlyPlaying).length;
            document.getElementById('listeningCount').textContent = listeningCount;
        }
    </script>
</body>
</html>