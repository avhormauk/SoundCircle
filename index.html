<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundCircle - Find Your Music Community</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hero-content {
            text-align: center;
            max-width: 600px;
        }

        .hero h1 {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            letter-spacing: -2px;
        }

        .tagline {
            font-size: 1.8rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #a0a0a0;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 18px 40px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .cta-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(59, 130, 246, 0.4);
        }

        .secondary-link {
            display: block;
            margin-top: 25px;
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .secondary-link:hover {
            color: #93c5fd;
        }

        .stats {
            margin-top: 40px;
            padding: 20px;
            background: #1f1f1f;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .stats p {
            color: #a0a0a0;
            font-size: 1rem;
        }

        .form-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .form-container {
            max-width: 600px;
            width: 100%;
            background: #1f1f1f;
            border-radius: 16px;
            padding: 40px;
            border: 1px solid #2a2a2a;
        }

        .form-container h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 15px;
        }

        .form-container > p {
            color: #a0a0a0;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .artists-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: #161616;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
        }

        .artist-tag {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .form-group select,
        .form-group input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            background: #161616;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group small {
            display: block;
            color: #666;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .privacy-note {
            background: #1a2332;
            border-left: 3px solid #60a5fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .privacy-note p {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin: 0;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .submit-button {
            flex: 2;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .submit-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .remove-button {
            flex: 1;
            background: #dc2626;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .remove-button:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .remove-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }

            .tagline {
                font-size: 1.4rem;
            }

            .form-container {
                padding: 30px 20px;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="hero" id="heroSection">
        <div class="hero-content">
            <h1>SoundCircle</h1>
            <p class="tagline">Find Your Music Community</p>
            <p class="subtitle">Discover people around you who share your taste</p>
            
            <button id="connectSpotify" class="cta-button">
                Link Your Spotify
            </button>
            
            <a href="discover.html" class="secondary-link">
                Browse the community â†’
            </a>

            <div class="stats">
                <p id="userCount">Loading community...</p>
            </div>
        </div>
    </div>

    <div class="form-section hidden" id="formSection">
        <div class="form-container">
            <h2>Welcome!</h2>
            <p>We found your music taste:</p>
            
            <div id="artistsDisplay" class="artists-display"></div>
            
            <form id="userForm">
                <div class="form-group">
                    <label for="location">Add Your University</label>
                    <select id="location" required>
                        <option value="">Select your university...</option>
                    </select>
                    <small>This helps you find nearby music buddies</small>
                </div>

                <div class="form-group">
                    <label for="contact">How can people reach you? (optional)</label>
                    <input type="text" id="contact" placeholder="e.g., @username on Instagram" maxlength="30">
                    <small>Leave blank if you want to stay anonymous (max 30 characters)</small>
                </div>

                <div class="privacy-note">
                    <p>Your data will be visible to other users. We only share what you see here.</p>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-button">Add/Update My Data</button>
                    <button type="button" id="removeData" class="remove-button">Remove My Data</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbDk7yBcmoq1f7YispIZty1J7M9sg8ycU",
            authDomain: "soundcircle-7ebd7.firebaseapp.com",
            projectId: "soundcircle-7ebd7",
            storageBucket: "soundcircle-7ebd7.firebasestorage.app",
            messagingSenderId: "313939828422",
            appId: "1:313939828422:web:3c45183871d17910b641c7"
        };

        const SPOTIFY_CLIENT_ID = '20e6dff041e1478694ba80cb2c952985';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-top-read user-read-email user-read-currently-playing';

        const UNIVERSITIES = [
            "University of California, Berkeley",
            "Stanford University",
            "University of California, Los Angeles",
            "University of Southern California",
            "California State University, Northridge",
            "San Francisco State University",
            "University of California, Davis",
            "University of California, Irvine",
            "University of California, San Diego",
            "California Polytechnic State University",
            "University of California, Santa Barbara",
            "University of California, Santa Cruz",
            "University of California, Riverside",
            "San Jose State University",
            "California State University, Long Beach"
        ];

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function generateCodeChallenge(verifier) {
            const hashed = await sha256(verifier);
            return base64urlencode(hashed);
        }

        function populateUniversities() {
            const locationSelect = document.getElementById('location');
            UNIVERSITIES.forEach(university => {
                const option = document.createElement('option');
                option.value = university;
                option.textContent = university;
                locationSelect.appendChild(option);
            });
        }

        document.getElementById('connectSpotify').addEventListener('click', async () => {
            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            localStorage.setItem('code_verifier', codeVerifier);
            
            const authUrl = new URL('https://accounts.spotify.com/authorize');
            authUrl.searchParams.append('client_id', SPOTIFY_CLIENT_ID);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.append('scope', SCOPES);
            authUrl.searchParams.append('code_challenge_method', 'S256');
            authUrl.searchParams.append('code_challenge', codeChallenge);
            
            window.location.href = authUrl.toString();
        });

        window.onload = async function() {
            populateUniversities();
            loadUserCount();

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                const codeVerifier = localStorage.getItem('code_verifier');
                if (codeVerifier) {
                    history.replaceState(null, null, window.location.pathname);
                    await exchangeCodeForToken(code, codeVerifier);
                    localStorage.removeItem('code_verifier');
                }
            }
        };

        async function exchangeCodeForToken(code, codeVerifier) {
            try {
                document.getElementById('heroSection').innerHTML = '<div class="hero-content"><h2>Loading your music taste...</h2></div>';
                
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: SPOTIFY_CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier,
                    }),
                });

                const data = await response.json();
                
                if (data.access_token) {
                    await getUserData(data.access_token);
                } else {
                    throw new Error(data.error_description || 'No access token received');
                }
            } catch (error) {
                console.error('Error exchanging code:', error);
                alert('Error connecting to Spotify: ' + error.message);
                location.reload();
            }
        }

        async function loadUserCount() {
            try {
                const snapshot = await db.collection('users').get();
                const count = snapshot.size;
                document.getElementById('userCount').textContent = 
                    `${count} ${count === 1 ? 'person has' : 'people have'} joined so far`;
            } catch (error) {
                console.error('Error loading count:', error);
                document.getElementById('userCount').textContent = 'Join the growing community!';
            }
        }

        async function getUserData(token) {
            try {
                const userRes = await fetch('https://api.spotify.com/v1/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await userRes.json();

                const artistsRes = await fetch('https://api.spotify.com/v1/me/top/artists?limit=5&time_range=short_term', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const artistsData = await artistsRes.json();
                
                let currentlyPlaying = null;
                try {
                    const currentlyPlayingRes = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (currentlyPlayingRes.status === 200) {
                        const currentlyPlayingData = await currentlyPlayingRes.json();
                        if (currentlyPlayingData && currentlyPlayingData.item) {
                            currentlyPlaying = {
                                name: currentlyPlayingData.item.name,
                                artist: currentlyPlayingData.item.artists[0].name,
                                url: currentlyPlayingData.item.external_urls.spotify
                            };
                        }
                    }
                } catch (error) {
                    console.log('Could not fetch currently playing track:', error);
                }

                if (!artistsData.items || artistsData.items.length === 0) {
                    alert('We couldn\'t find your top artists. Make sure you\'ve been listening to music on Spotify!');
                    location.reload();
                    return;
                }

                showForm(user, artistsData, currentlyPlaying);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error connecting to Spotify. Please try again.');
                location.reload();
            }
        }

        function showForm(user, artistsData, currentlyPlaying) {
            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('formSection').classList.remove('hidden');
            
            const artists = artistsData.items.map(a => a.name);
            document.getElementById('artistsDisplay').innerHTML = 
                artists.map(a => `<span class="artist-tag">${a}</span>`).join('');
            
            window.userData = {
                name: user.display_name || 'Anonymous User',
                spotifyUrl: user.external_urls.spotify,
                artists: artists,
                spotifyId: user.id,
                email: user.email,
                currentlyPlaying: currentlyPlaying,
                lastUpdated: new Date().toISOString()
            };

            checkExistingUser(user.id);
        }

        async function checkExistingUser(spotifyId) {
            try {
                const existingUser = await db.collection('users')
                    .where('spotifyId', '==', spotifyId)
                    .get();

                if (!existingUser.empty) {
                    const userData = existingUser.docs[0].data();
                    document.getElementById('location').value = userData.location || '';
                    document.getElementById('contact').value = userData.contact || '';
                }
            } catch (error) {
                console.error('Error checking existing user:', error);
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            
            const location = document.getElementById('location').value.trim();
            const contact = document.getElementById('contact').value.trim();
            
            if (!location) {
                alert('Please select your university!');
                submitButton.disabled = false;
                submitButton.textContent = 'Add/Update My Data';
                return;
            }
            
            try {
                const existingUser = await db.collection('users')
                    .where('spotifyId', '==', window.userData.spotifyId)
                    .get();

                if (!existingUser.empty) {
                    const docId = existingUser.docs[0].id;
                    await db.collection('users').doc(docId).update({
                        location: location,
                        contact: contact,
                        artists: window.userData.artists,
                        currentlyPlaying: window.userData.currentlyPlaying,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await db.collection('users').add({
                        ...window.userData,
                        location: location,
                        contact: contact || null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                alert('Your data has been saved!');
                window.location.href = 'discover.html';
                
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving data. Please try again.\n\n' + error.message);
                submitButton.disabled = false;
                submitButton.textContent = 'Add/Update My Data';
            }
        });

        document.getElementById('removeData').addEventListener('click', async function() {
            if (!window.userData || !window.userData.spotifyId) {
                alert('No user data found to remove.');
                return;
            }

            if (!confirm('Are you sure you want to remove your data from SoundCircle? This action cannot be undone.')) {
                return;
            }

            const button = this;
            button.disabled = true;
            button.textContent = 'Removing...';

            try {
                const existingUser = await db.collection('users')
                    .where('spotifyId', '==', window.userData.spotifyId)
                    .get();

                if (!existingUser.empty) {
                    const docId = existingUser.docs[0].id;
                    await db.collection('users').doc(docId).delete();
                    alert('Your data has been removed from SoundCircle.');
                    window.location.href = 'index.html';
                } else {
                    alert('No data found to remove.');
                    button.disabled = false;
                    button.textContent = 'Remove My Data';
                }
            } catch (error) {
                console.error('Error removing data:', error);
                alert('Error removing data. Please try again.');
                button.disabled = false;
                button.textContent = 'Remove My Data';
            }
        });
    </script>
</body>
</html>